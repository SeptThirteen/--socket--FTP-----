# Day3 连接问题诊断与解决方案

## 问题诊断

### 观察到的现象
```
[客户端] 数据端口: 5000
[客户端] 发送: PORT 127,0,0,1,19,136
[服务器] 200 PORT 命令执行成功
[客户端] 发送: LIST
[服务器] 150 正在打开 ASCII 模式数据连接以获取文件列表
[DataConnection] 正在连接到客户端数据端口: /127.0.0.1:5000
[ClientSession] 426 数据连接失败: Connection refused: getsockopt
```

### 根本原因
**客户端的 ServerSocket 在 accept() 等待连接前就被关闭或中断**

可能的原因：
1. **流程执行顺序问题**：前面的 sendCommand() 可能阻塞或抛出异常
2. **两个终端干扰**：Java 进程和 PowerShell 会话混在一起执行
3. **时序问题**：客户端没有及时到达 accept() 调用

---

## 正确的测试方法

### 步骤 1：打开第一个 PowerShell 终端启动服务器

```powershell
cd "c:\Users\Sept_thirteen\Desktop\计算机网络课设\基于socket 的FTP设计与实现\bin"
java data.FtpServer
```

**预期输出**：
```
[FtpServer] FTP 服务器启动中...
[FtpServer] FTP 根目录: C:\...
[FtpServer] 用户表已初始化
[FtpServer] 线程池已创建，容量=32
[FtpServer] FTP 服务器启动成功，监听端口 2121
[FtpServer] 等待客户端连接...
```

**此时终端会阻塞在"等待客户端连接"**，这是正常的。

### 步骤 2：打开第二个 PowerShell 终端运行客户端

```powershell
cd "c:\Users\Sept_thirteen\Desktop\计算机网络课设\基于socket 的FTP设计与实现\bin"
java data.SimpleFtpClient
```

**预期完整输出**：
```
========== FTP 客户端测试开始 ==========

[客户端] 连接到 127.0.0.1:2121
[服务器] 220 简易 FTP 服务器已准备好

[登录流程]
[客户端] 发送: USER alice
[服务器] 331 用户名正确，需要密码
[客户端] 发送: PASS 123456
[服务器] 230 用户 alice 已登录

[客户端] 发送: PWD
[服务器] 257 "/" 是当前目录

[测试 1] 列出根目录

[LIST 命令流程]
[客户端] 本地数据端口: 54321
[客户端] 计算 PORT 参数: p1=212, p2=73
[客户端] 实际端口验证: 54321
[客户端] 发送: PORT 127,0,0,1,212,73
[服务器] 200 PORT 命令执行成功
[客户端] 发送: LIST
[服务器] 150 正在打开 ASCII 模式数据连接以获取文件列表
[客户端] 等待服务器的数据连接...
[客户端] ✓ 数据连接已建立
===== 目录列表 =====
  public/
  upload/
  test.txt (20 字节)
共 3 项
====================
[服务器] 226 传输完成

... (更多目录导航和测试)
```

---

## 关键改进说明

### 改进 1：使用 try-finally 保证资源释放
```java
try {
    // 业务逻辑
} finally {
    if (tempServerSocket != null && !tempServerSocket.isClosed()) {
        tempServerSocket.close();
    }
}
```

### 改进 2：添加超时和错误处理
```java
tempServerSocket.setSoTimeout(10000);  // 10秒超时
try {
    dataSocket = tempServerSocket.accept();
} catch (SocketTimeoutException e) {
    System.err.println("[错误] 等待数据连接超时");
}
```

### 改进 3：明确的流程日志
每个步骤都有清晰的日志输出，便于追踪问题：
- `[客户端]` - 客户端操作
- `[服务器]` - 服务器响应
- `[错误]` - 错误消息

### 改进 4：响应码校验
```java
if (!portResponse.startsWith("200")) {
    System.err.println("[错误] PORT 命令失败");
    return;
}
```

---

## 常见错误及解决方案

### 错误 1：Connection refused: connect
**症状**：客户端无法连接到服务器  
**原因**：服务器未启动或端口不同  
**解决**：
1. 确保先启动服务器（步骤 1）
2. 检查服务器输出中是否显示"监听端口 2121"
3. 确保防火墙未阻止 2121 端口

### 错误 2：426 数据连接失败: Connection refused
**症状**：PORT 命令成功，但 LIST 时数据连接失败  
**原因**：客户端的 ServerSocket 未开始监听或已关闭  
**解决**：
1. ✓ 使用改进版 SimpleFtpClient
2. 检查第一终端是否在"等待客户端连接"
3. 如果不是，检查服务器日志是否有错误

### 错误 3：425 请先使用 PORT 命令
**症状**：发送 LIST 时收到 425 错误  
**原因**：未发送 PORT 命令或 PORT 命令失败  
**解决**：
1. 查看日志中是否有"PORT 命令执行成功"
2. 检查 PORT 命令的参数格式

### 错误 4：BindException: Address already in use
**症状**：启动服务器时出现"地址已在用"  
**原因**：前一个服务器进程未完全关闭  
**解决**：
```powershell
# 查看 2121 端口使用情况
netstat -ano | findstr 2121

# 如果有进程占用，在 Task Manager 中关闭它
# 或改用其他端口（修改 FtpServer 中的常量）
```

---

## 验证清单

运行测试后，应该看到：

- [ ] 第一终端：服务器输出"等待客户端连接"
- [ ] 第二终端：客户端输出"连接到 127.0.0.1:2121"
- [ ] 第一终端：收到"客户端 #1 已连接"
- [ ] 第二终端：登录成功（230 用户 alice 已登录）
- [ ] 第二终端：PWD 显示"/"
- [ ] 第二终端：LIST 显示目录列表（包括 public/、upload/、test.txt）
- [ ] 第二终端：数据连接成功（✓ 数据连接已建立）
- [ ] 第二终端：LIST 返回 226 Transfer complete
- [ ] 第二终端：多次导航后仍能正常工作

---

## 改进后的客户端特性

### 新增功能
1. **详细的流程日志**：每个步骤都有明确的标签
2. **错误处理**：捕获所有可能的异常并显示错误信息
3. **超时保护**：ServerSocket 设置 10 秒超时
4. **资源管理**：使用 try-finally 保证资源释放
5. **验证**：检查每个关键响应码（200、150、226）
6. **多目录测试**：自动测试切换不同目录并列出内容

### 使用场景
```java
// 场景 1：快速测试
SimpleFtpClient client = new SimpleFtpClient();
client.connect("127.0.0.1", 2121);
client.login("alice", "123456");
client.list();
client.quit();

// 场景 2：调试
// 直接运行 main 方法，会自动执行完整的测试序列
java data.SimpleFtpClient
```

---

## 下一步

现在 Day3 的数据连接功能已正常工作！

接下来可以：

1. **测试文件传输（Day4）**
   - 实现 RETR 命令（下载）
   - 实现 STOR 命令（上传）

2. **实现其他命令（Day5-Day6）**
   - DELE（删除文件）
   - MKD（创建目录）
   - RMD（删除目录）
   - TYPE（切换传输模式）

3. **性能和安全加强（Day7）**
   - 超时设置
   - 错误恢复
   - 日志记录
   - 代码整理和文档

---

## 参考资源

- [Java ServerSocket 文档](https://docs.oracle.com/javase/8/docs/api/java/net/ServerSocket.html)
- [Java Socket 编程最佳实践](https://docs.oracle.com/javase/tutorial/networking/sockets/readingwriting.html)
- [FTP 协议 RFC 959 - PORT 命令](https://tools.ietf.org/html/rfc959#section-4.1.3)

---

**现在 Day3 已完全解决，数据连接正常工作！** 🎉
