# 编码问题与解决方案 📡🔧

## 概要
简要记录在本项目中遇到的**客户端/服务器字符编码不一致**导致的中文乱码与按键控制序列干扰问题，并给出可行的短期/中期/长期解决方案与测试步骤。

---

## 常见症状
- 启动服务器后，使用 Windows 自带 telnet 客户端看到中文变成乱码（例如“简易 FTP 服务器已准备好”显示异常）。
- 客户端发送命令后服务器显示乱码或收到错误的字节导致命令识别失败（返回 `500 Unknown command`）。
- 在 telnet 中按方向键可能发送控制序列（如 `\x1B[A` / 显示为 `[A`）被服务器当作命令文本。

---

## 根因分析 🧐
- Windows 自带 telnet 通常使用 **GBK/CP936**（依赖控制台代码页 `chcp`），而服务器最初使用 **UTF-8**；两端字符集不一致会导致乱码。
- Microsoft Telnet 本身没有独立的字符集配置，它依赖系统控制台编码（`chcp`），且对 UTF-8 支持不稳定。
- 客户端可能会发送 ANSI/VT100 控制序列（方向键、功能键），这些字节会进入服务器的命令解析流，造成非预期字符串。
- 如果服务器端用 `InputStreamReader`/`OutputStreamWriter` 等未显式指定字符集，默认会用 JVM 平台默认编码，进一步增加不确定性。

---

## 解决方案（按紧急程度）

### 短期（快速修复） ✅
- **把服务器会话读写字符集改为 GBK（CP936）**，使其与 Windows telnet/GBK 终端兼容（我们已在 `src/ClientSession.java` 中按此修改）。
- **更换客户端**：推荐使用 PuTTY / Tera Term 等客户端，能在设置里选择远端字符集为 `GBK` 或 `CP936`，显示更可靠。
- 在 Windows 自带 telnet 前执行：

  ```bat
  chcp 936
  telnet 127.0.0.1 2121
  ```

  但注意：`chcp 936` 能提高显示正确性，但并不能消除方向键等控制序列问题。

### 中期（稳健性提升） ⚙️
- **在服务器端清洗/过滤控制序列**：在解析命令前移除以 ESC (`0x1B`) 开头的 ANSI 序列（示例正则：`\x1B\[[0-9;]*[A-Za-z]`），并剔除不可见字节（如 0x00~0x1F 除 CR/LF）。
- **显式在代码中指定字符集**（不要依赖 JVM 默认编码）：例如在构造 `BufferedReader`/`BufferedWriter` 时使用 `Charset.forName("GBK")` 或 `StandardCharsets.UTF_8`。

### 长期（用户体验与兼容性） 🌐
- **统一使用 UTF-8**（推荐在互联网/跨平台场景）：将服务器改为 UTF-8 并为用户提供明确的客户端配置说明（或提供一个小脚本/客户端），避免区域编码问题。
- **提供更友好的客户端或 Web UI**，避免直接依赖老旧 telnet 行为并能更好地处理终端控制序列和编码问题。

---

## 测试步骤（建议） 🧪
1. 使用 PuTTY：
   - Connection type: Telnet
   - Host: `127.0.0.1`, Port: `2121`
   - Window → Translation → Remote character set: **`GBK`** 或 `CP936`
   - 预期：欢迎语中文正常显示，输入 `USER test` 等命令服务器正确解析。

2. 使用 Windows 自带 telnet：
   - 在 CMD 里执行 `chcp 936`，再运行 `telnet 127.0.0.1 2121`，输入 `USER` / `PASS` / `QUIT` 测试。

3. 使用 PowerShell 做更严格的测试（示例，发送并接收 GBK 编码）：

```powershell
$client = New-Object System.Net.Sockets.TcpClient('127.0.0.1',2121)
$stream = $client.GetStream()
$encoding = [System.Text.Encoding]::GetEncoding('gbk')
$sr = New-Object System.IO.StreamReader($stream, $encoding)
$sw = New-Object System.IO.StreamWriter($stream, $encoding)
$sw.AutoFlush = $true
$sw.WriteLine('USER test')
$line = $sr.ReadLine()
Write-Host $line
```

4. 验证控制序列问题：用支持显示字节的工具（Wireshark 或 PowerShell 捕获原始字节）看按键时发送的字节是否包含 `0x1B` (ESC)。

---

## 常用工具 & 建议客户端 🧰
- 推荐客户端：**PuTTY**, **Tera Term**（都可配置字符集）✅
- 调试工具：**Wireshark**, **PowerShell/TCP 客户端脚本**, **netcat/ncat**（如可用）

---

## 快速建议（给开发者）💡
- 如果要兼容 Windows 自带 telnet，**把会话编码设置为 GBK** 并在 README 中明确说明客户端需用 GBK。已实现的更改位于：`src/ClientSession.java`。
- 若目标是跨平台或互联网用户，考虑将协议升级为 UTF-8 并提供客户端/文档来帮助用户配置终端为 UTF-8（或提供 web 控制台）。
- 对输入做最小清洗（剔除可见性控制字符），能显著降低方向键等意外输入对服务器命令解析的干扰。

---

如果你希望，我可以：
- 把 PuTTY 的具体配置步骤（含截图/逐步设置）写入本文件；或
- 在 `ClientSession` 中加入一段示例代码来**过滤 ANSI 控制序列**并提交为 PR；或
- 将此文档同时翻译成英文以便共享。

要我接着做哪项？（例如：添加 PuTTY 配置截图 / 添加输入过滤代码示例 / 统一改为 UTF-8 并生成迁移说明）
